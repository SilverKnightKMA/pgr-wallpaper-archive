name: Cleanup

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 1

      - name: Delete all branches except main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use gh api to delete branches (no need to fetch anything)
          branches=$(gh api repos/${{ github.repository }}/branches --paginate -q '.[].name' | grep -v '^main$') || true
          if [ -z "$branches" ]; then
            echo "No branches to delete."
          else
            for branch in $branches; do
              echo "Deleting branch: $branch"
              gh api -X DELETE "repos/${{ github.repository }}/git/refs/heads/$branch" 2>/dev/null || true
            done
          fi

      - name: Delete data and preview directories
        run: |
          deleted=false
          for dir in data preview; do
            if [ -d "$dir" ]; then
              git rm -rf "$dir"
              deleted=true
              echo "Staged $dir for deletion."
            fi
          done
          if [ "$deleted" = true ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "chore: remove data and preview directories"
            git push origin main
          else
            echo "No directories to delete."
          fi

      - name: Delete all releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete releases in parallel (up to 10 at a time)
          gh release list --limit 1000 --json tagName -q '.[].tagName' | \
            xargs -P 10 -I {} sh -c 'echo "Deleting release: {}" && gh release delete "{}" --yes --cleanup-tag' || true
          echo "All releases deleted."

      - name: Delete all Git tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tags=$(gh api repos/${{ github.repository }}/tags --paginate -q '.[].name') || true
          if [ -z "$tags" ]; then
            echo "No tags to delete."
          else
            count=$(echo "$tags" | wc -l)
            echo "Deleting $count tags..."
            for tag in $tags; do
              gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/$tag" 2>/dev/null || true
            done
          fi
