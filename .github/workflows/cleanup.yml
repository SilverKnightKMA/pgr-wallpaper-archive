name: Cleanup

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 1

      - name: Delete all branches except main
        run: |
          # Use ls-remote instead of fetch --prune (no need to download objects)
          branches=$(git ls-remote --heads origin | awk -F'refs/heads/' '{print $2}' | grep -v '^main$')
          if [ -z "$branches" ]; then
            echo "No branches to delete."
          else
            # Batch delete all branches in one push command
            delete_refs=""
            for branch in $branches; do
              echo "Will delete branch: $branch"
              delete_refs="$delete_refs :refs/heads/$branch"
            done
            git push origin $delete_refs || true
          fi

      - name: Delete data and preview directories
        run: |
          deleted=false
          for dir in data preview; do
            if [ -d "$dir" ]; then
              git rm -rf "$dir"
              deleted=true
              echo "Staged $dir for deletion."
            fi
          done
          if [ "$deleted" = true ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "chore: remove data and preview directories"
            git push origin main
          else
            echo "No directories to delete."
          fi

      - name: Delete all releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete releases in parallel (up to 10 at a time)
          gh release list --limit 1000 --json tagName -q '.[].tagName' | \
            xargs -P 10 -I {} sh -c 'echo "Deleting release: {}" && gh release delete "{}" --yes --cleanup-tag' || true
          echo "All releases deleted."

      - name: Delete all Git tags
        run: |
          # Use ls-remote to list tags without downloading objects
          tags=$(git ls-remote --tags origin | awk -F'refs/tags/' '{print $2}' | grep -v '\^{}$')
          if [ -z "$tags" ]; then
            echo "No tags to delete."
          else
            # Batch delete all tags in one push command
            delete_refs=""
            for tag in $tags; do
              delete_refs="$delete_refs :refs/tags/$tag"
            done
            echo "Deleting $(echo "$tags" | wc -l) tags in one batch..."
            git push origin $delete_refs || true
          fi
