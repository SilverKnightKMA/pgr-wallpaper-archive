name: PGR Wallpapers Downloader

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      max_images:
        description: 'Maximum number of images allowed before triggering downloader.'
        required: false
        default: 1000

jobs:
  scrape-and-download:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      has_new_images: ${{ steps.check_new.outputs.has_new }}
      release_tag: ${{ steps.set_tag.outputs.tag }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 18
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Ensure per-server branches exist
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          REMOTE_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          SERVERS=$(node -e "const c=require('./config.json'); c.servers.forEach(s => console.log(s.id + ' ' + s.branch))")
          while IFS=' ' read -r id branch; do
            if git ls-remote --exit-code origin "$branch" >/dev/null 2>&1; then
              echo "‚úÖ Branch $branch already exists."
            else
              echo "üÜï Creating new orphan branch: $branch"
              INIT_DIR=$(mktemp -d)
              git -C "$INIT_DIR" init
              git -C "$INIT_DIR" remote add origin "$REMOTE_URL"
              git -C "$INIT_DIR" checkout -b "$branch"
              git -C "$INIT_DIR" commit --allow-empty -m "Initialize branch $branch"
              git -C "$INIT_DIR" push origin "$branch"
              rm -rf "$INIT_DIR"
              echo "  ‚úÖ Branch $branch created."
            fi
          done <<< "$SERVERS"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create branch working directories
        run: |
          # For each server, checkout existing branch content if it exists
          SERVERS=$(node -e "const c=require('./config.json'); c.servers.forEach(s => console.log(s.id + ' ' + s.branch))")
          while IFS=' ' read -r id branch; do
            mkdir -p "branches/$id"
            if git ls-remote --exit-code origin "$branch" >/dev/null 2>&1; then
              echo "üì• Fetching existing branch: $branch"
              git fetch origin "$branch" --depth=1
              git worktree add "worktree-$id" "origin/$branch" --detach 2>/dev/null || true
              # Copy existing images to branches dir
              if [ -d "worktree-$id" ]; then
                find "worktree-$id" -maxdepth 1 -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' \) -exec cp {} "branches/$id/" \;
                git worktree remove "worktree-$id" --force 2>/dev/null || true
              fi
            else
              echo "‚ö†Ô∏è Branch $branch does not exist (unexpected at this point)."
            fi
          done <<< "$SERVERS"

      - name: Scrape Links
        env:
          MAX_IMAGES: ${{ inputs.max_images }}
        run: node src/scraper.js

      - name: Download Wallpapers
        shell: pwsh
        run: ./src/downloader.ps1

      - name: Generate Thumbnails
        run: |
          SERVERS=$(node -e "const c=require('./config.json'); c.servers.forEach(s => console.log(s.id))")
          while IFS= read -r id; do
            THUMB_WIDTH=$(node -e "const c=require('./config.json'); console.log(c.settings.thumbnailWidth || 400)")
            if [ -d "branches/$id" ]; then
              bash src/generate_thumbnails.sh "branches/$id" "$THUMB_WIDTH"
            fi
          done <<< "$SERVERS"

      - name: Check for new images
        id: check_new
        run: |
          new_count=0
          SERVERS=$(node -e "const c=require('./config.json'); c.servers.forEach(s => console.log(s.id))")
          while IFS= read -r id; do
            txt="Wallpapers/images_url/${id}.txt"
            if [ -f "$txt" ] && [ -s "$txt" ]; then
              count=$(wc -l < "$txt")
              new_count=$((new_count + count))
            fi
          done <<< "$SERVERS"
          echo "New images found: $new_count"
          if [ "$new_count" -gt 0 ]; then
            echo "has_new=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_new=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set release tag
        id: set_tag
        if: steps.check_new.outputs.has_new == 'true'
        run: |
          TAG="wallpapers-$(date -u +%Y%m%d-%H%M%S)"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Release tag: $TAG"

      - name: Push images to per-server branches
        if: steps.check_new.outputs.has_new == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          REPO_DIR="$(pwd)"
          REMOTE_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          SERVERS=$(node -e "const c=require('./config.json'); c.servers.forEach(s => console.log(s.id + ' ' + s.branch))")
          while IFS=' ' read -r id branch; do
            BRANCH_DIR="$REPO_DIR/branches/$id"
            IMAGE_COUNT=$(find "$BRANCH_DIR" -maxdepth 1 -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' \) 2>/dev/null | wc -l)
            if [ ! -d "$BRANCH_DIR" ] || [ "$IMAGE_COUNT" -eq 0 ]; then
              echo "‚è≠Ô∏è No images for $id, skipping branch push."
              continue
            fi

            echo "üîÄ Processing branch: $branch (server: $id, $IMAGE_COUNT images)"

            # Create a temporary directory for branch work
            WORK_DIR="$(mktemp -u)"

            # Clone the branch (guaranteed to exist from pre-creation step)
            git clone --single-branch --branch "$branch" --depth 1 "$REMOTE_URL" "$WORK_DIR"

            # Copy images and thumbnails
            find "$BRANCH_DIR" -maxdepth 1 -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' \) -exec cp {} "$WORK_DIR/" \;
            if [ -d "$BRANCH_DIR/thumbnails" ]; then
              mkdir -p "$WORK_DIR/thumbnails"
              find "$BRANCH_DIR/thumbnails" -maxdepth 1 -type f -exec cp {} "$WORK_DIR/thumbnails/" \;
            fi

            # Generate branch README directly in WORK_DIR
            BRANCH_DIR="$WORK_DIR" BRANCH_README_OUTPUT="$WORK_DIR/README.md" node "$REPO_DIR/src/generate_readme.js" branch "$id"

            # Commit and push
            git -C "$WORK_DIR" config user.name "github-actions[bot]"
            git -C "$WORK_DIR" config user.email "github-actions[bot]@users.noreply.github.com"
            git -C "$WORK_DIR" add -A
            if git -C "$WORK_DIR" diff --cached --quiet; then
              echo "  No changes for $branch."
            else
              git -C "$WORK_DIR" commit -m "Auto-sync: Update $id wallpapers"
              git -C "$WORK_DIR" push origin HEAD:"$branch" --force-with-lease
              echo "  ‚úÖ Pushed to $branch"
            fi
            rm -rf "$WORK_DIR"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update main README
        if: steps.check_new.outputs.has_new == 'true'
        run: |
          node src/generate_readme.js main
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --cached --quiet; then
            echo "No README changes."
          else
            git commit -m "Auto-sync: Update main README with branch links"
            git push
          fi

      - name: Collect release assets
        if: steps.check_new.outputs.has_new == 'true'
        id: release_notes
        run: |
          mkdir -p release_assets release_staging
          RELEASE_BODY=""
          HAS_FILES=false
          SERVERS=$(node -e "const c=require('./config.json'); c.servers.forEach(s => console.log(s.id + '|' + s.name + '|' + s.branch))")
          while IFS='|' read -r id name branch; do
            txt="Wallpapers/images_url/${id}.txt"
            if [ -f "$txt" ] && [ -s "$txt" ]; then
              BRANCH_DIR="branches/$id"
              FILE_COUNT=0
              while IFS= read -r url; do
                filename=$(basename "$url")
                if [ -f "$BRANCH_DIR/$filename" ]; then
                  FILE_COUNT=$((FILE_COUNT + 1))
                fi
              done < "$txt"

              # Copy new images into a per-server folder for the zip
              if [ $FILE_COUNT -gt 0 ]; then
                HAS_FILES=true
                mkdir -p "release_staging/$id"
                while IFS= read -r url; do
                  filename=$(basename "$url")
                  if [ -f "$BRANCH_DIR/$filename" ]; then
                    cp "$BRANCH_DIR/$filename" "release_staging/$id/$filename"
                  fi
                done < "$txt"

                # Build release notes section for this server
                RELEASE_BODY="${RELEASE_BODY}### üñºÔ∏è ${name} (${FILE_COUNT} new)\n\n"
                RELEASE_BODY="${RELEASE_BODY}üìÅ **Folder:** \`${id}/\`\n"
                RELEASE_BODY="${RELEASE_BODY}üîó **Branch:** [\`${branch}\`](https://github.com/${GITHUB_REPOSITORY}/tree/${branch})\n\n"

                RELEASE_BODY="${RELEASE_BODY}<details><summary>üìã File list & preview</summary>\n\n"
                RELEASE_BODY="${RELEASE_BODY}| Preview | Filename | URL |\n"
                RELEASE_BODY="${RELEASE_BODY}|---------|----------|-----|\n"
                while IFS= read -r url; do
                  filename=$(basename "$url")
                  thumb_url="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${branch}/thumbnails/$(python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.argv[1], safe='%'))" "$filename")"
                  RELEASE_BODY="${RELEASE_BODY}| <img src=\"${thumb_url}\" width=\"100\"> | \`${filename}\` | [Link](${url}) |\n"
                done < "$txt"
                RELEASE_BODY="${RELEASE_BODY}\n</details>\n\n---\n\n"
              fi
            fi
          done <<< "$SERVERS"

          # Create a single zip with per-server folders
          if [ "$HAS_FILES" = true ]; then
            cd release_staging
            zip -r "../release_assets/${RELEASE_TAG}.zip" .
            cd ..
          fi

          # Write release body to file
          echo -e "$RELEASE_BODY" > release_notes.md

          # Output whether we have files to release
          echo "has_files=$HAS_FILES" >> "$GITHUB_OUTPUT"
        env:
          RELEASE_TAG: ${{ steps.set_tag.outputs.tag }}

      - name: Create GitHub Release
        if: steps.check_new.outputs.has_new == 'true' && steps.release_notes.outputs.has_files == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.set_tag.outputs.tag }}
          name: "Wallpapers ${{ steps.set_tag.outputs.tag }}"
          body_path: release_notes.md
          files: release_assets/${{ steps.set_tag.outputs.tag }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
