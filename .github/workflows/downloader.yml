name: PGR Wallpapers Downloader

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      max_images:
        description: 'Maximum number of images to scrape per server (not counting existing images).'
        required: false
        default: 10000

jobs:
  scrape-and-download:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      has_new_images: ${{ steps.check_new.outputs.has_new }}
      release_tag: ${{ steps.set_tag.outputs.tag }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Ensure branches exist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bash src/init_branches.sh

      - name: Load existing image manifest for comparison
        run: |
          mkdir -p data
          SERVERS=$(python3 -c "import json; c=json.load(open('config.json')); [print(s['id']) for s in c['servers']]")
          if [ -f "data/manifest.json" ]; then
            while IFS= read -r id; do
              mkdir -p "branches/$id"
              python3 src/prepare_manifest.py "$id" > "branches/$id/.existing_images"
            done <<< "$SERVERS"
          else
            while IFS= read -r id; do mkdir -p "branches/$id"; done <<< "$SERVERS"
          fi

      - name: Scrape Links
        env:
          MAX_IMAGES: ${{ inputs.max_images }}
        run: python3 src/scraper.py

      - name: Retry broken links
        run: |
          SERVERS=$(python3 -c "import json; c=json.load(open('config.json')); [print(s['id']) for s in c['servers']]")
          for cat in desktop mobile; do
            while IFS= read -r id; do
              if [ -s "Wallpapers/failed/${id}_${cat}.txt" ]; then
                grep -vxFf "Wallpapers/images_url/${id}_${cat}.txt" "Wallpapers/failed/${id}_${cat}.txt" >> "Wallpapers/images_url/${id}_${cat}.txt" || true
              fi
            done <<< "$SERVERS"
          done

      - name: Check for new images
        id: check_new
        run: |
          has_new=false
          SERVERS=$(python3 -c "import json; c=json.load(open('config.json')); [print(s['id']) for s in c['servers']]")
          while IFS= read -r id; do
            for cat in desktop mobile; do
              txt="Wallpapers/images_url/${id}_${cat}.txt"
              if [ -f "$txt" ] && [ -s "$txt" ]; then
                count=$(wc -l < "$txt")
                echo "New $cat images for $id: $count"
                has_new=true
              fi
            done
          done <<< "$SERVERS"
          echo "has_new=$has_new" >> "$GITHUB_OUTPUT"

      - name: Set release tag
        id: set_tag
        if: steps.check_new.outputs.has_new == 'true'
        run: |
          TAG="wallpapers-$(date -u +%Y%m%d-%H%M%S)"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          TAG_TS=$(echo "$TAG" | sed 's/wallpapers-\([0-9]\{4\}\)\([0-9]\{2\}\)\([0-9]\{2\}\)-\([0-9]\{2\}\)\([0-9]\{2\}\)\([0-9]\{2\}\)/\1-\2-\3T\4:\5:\6Z/')
          echo "timestamp=$TAG_TS" >> "$GITHUB_OUTPUT"

      - name: Download Wallpapers
        if: steps.check_new.outputs.has_new == 'true'
        run: python3 src/downloader.py

      - name: Organize Images & Generate Thumbnails
        if: steps.check_new.outputs.has_new == 'true'
        run: |
          SERVERS=$(python3 -c "import json; c=json.load(open('config.json')); [print(s['id']) for s in c['servers']]")
          THUMB_WIDTH=$(python3 -c "import json; c=json.load(open('config.json')); print(c.get('settings',{}).get('thumbnailWidth',400))")
          
          while IFS= read -r id; do
            for cat in desktop mobile; do
              SRC_DIR="branches/$id/$cat"
              if [ -d "$SRC_DIR" ]; then
                # Move images to images/{category}/
                mkdir -p "branches/$id/images/$cat"
                find "$SRC_DIR" -maxdepth 1 -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' \) -exec mv {} "branches/$id/images/$cat/" \;
                
                # Generate Thumbnails
                if [ -d "branches/$id/images/$cat" ]; then
                  bash src/generate_thumbnails.sh "branches/$id/images/$cat" "$THUMB_WIDTH"
                  # Organize thumbnails
                  if [ -d "branches/$id/images/$cat/thumbnails" ]; then
                    mkdir -p "branches/$id/thumbnails/$cat"
                    find "branches/$id/images/$cat/thumbnails" -maxdepth 1 -type f -exec mv {} "branches/$id/thumbnails/$cat/" \;
                    rmdir "branches/$id/images/$cat/thumbnails" 2>/dev/null || true
                  fi
                fi
              fi
            done
          done <<< "$SERVERS"

      - name: Sync Repo (Push Images & Previews)
        if: steps.check_new.outputs.has_new == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG_TS: ${{ steps.set_tag.outputs.timestamp }}
        run: |
          # Save old manifest for comparison before sync builds a new one
          if [ -f data/manifest.json ]; then
            cp data/manifest.json data/manifest_old.json
          else
            echo '{}' > data/manifest_old.json
          fi
          bash src/sync_repo.sh

      - name: Cleanup preview files
        if: steps.check_new.outputs.has_new == 'true'
        run: |
          SERVERS=$(python3 -c "import json; c=json.load(open('config.json')); [print(s['id']) for s in c['servers']]")
          while IFS= read -r id; do
            rm -rf "branches/$id/thumbnails"
          done <<< "$SERVERS"
          echo "âœ… Preview files cleaned up"

      - name: Diff manifests for release
        if: steps.check_new.outputs.has_new == 'true'
        run: |
          mkdir -p new_images
          python3 src/diff_manifest.py data/manifest_old.json data/manifest.json new_images

      - name: Update main README
        if: steps.check_new.outputs.has_new == 'true'
        run: |
          MANIFEST_PATH="$(pwd)/data/manifest.json" python3 src/generate_readme.py main
          if [ ! -f docs/favicon.png ]; then
            curl -sL -o docs/favicon.png "https://cdnstatic.kurogame.net/h5_manage_dist/pgr_website2.0/favicon.png" || true
          fi
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md data/manifest.json
          [ -f docs/favicon.png ] && git add docs/favicon.png
          if ! git diff --cached --quiet; then
            git commit -m "Auto-sync: Update main README and manifest"
            git push
          fi

      - name: Create Release Notes
        if: steps.check_new.outputs.has_new == 'true'
        id: release_notes
        env:
          RELEASE_TAG: ${{ steps.set_tag.outputs.tag }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: python3 src/create_release_body.py

      - name: Create Release & Upload Zipped Assets
        if: steps.check_new.outputs.has_new == 'true' && steps.release_notes.outputs.has_files == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create the release first
          gh release create "${{ steps.set_tag.outputs.tag }}" \
            --title "${{ steps.set_tag.outputs.tag }}" \
            --notes-file release_notes.md

          # Zip in batches (<1.8GB each), upload each, then delete zip + source images
          bash src/zip_and_release.sh "${{ steps.set_tag.outputs.tag }}"
