name: PGR Wallpapers Downloader

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      max_images:
        description: 'Maximum number of images allowed before triggering downloader.'
        required: false
        default: 1000

jobs:
  scrape-and-download:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      has_new_images: ${{ steps.check_new.outputs.has_new }}
      release_tag: ${{ steps.set_tag.outputs.tag }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 18
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Create branch working directories
        run: |
          # For each server, checkout existing branch content if it exists
          SERVERS=$(node -e "const c=require('./config.json'); c.servers.forEach(s => console.log(s.id + ' ' + s.branch))")
          while IFS=' ' read -r id branch; do
            mkdir -p "branches/$id"
            if git ls-remote --exit-code origin "$branch" >/dev/null 2>&1; then
              echo "ðŸ“¥ Fetching existing branch: $branch"
              git fetch origin "$branch" --depth=1
              git worktree add "worktree-$id" "origin/$branch" --detach 2>/dev/null || true
              # Copy existing images to branches dir
              if [ -d "worktree-$id" ]; then
                find "worktree-$id" -maxdepth 1 -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' \) -exec cp {} "branches/$id/" \;
                git worktree remove "worktree-$id" --force 2>/dev/null || true
              fi
            else
              echo "ðŸ†• Branch $branch does not exist yet, will be created."
            fi
          done <<< "$SERVERS"

      - name: Scrape Links
        env:
          MAX_IMAGES: ${{ inputs.max_images }}
        run: node src/scraper.js

      - name: Download Wallpapers
        shell: pwsh
        run: ./src/downloader.ps1

      - name: Generate Thumbnails
        run: |
          SERVERS=$(node -e "const c=require('./config.json'); c.servers.forEach(s => console.log(s.id))")
          while IFS= read -r id; do
            THUMB_WIDTH=$(node -e "const c=require('./config.json'); console.log(c.settings.thumbnailWidth || 400)")
            if [ -d "branches/$id" ]; then
              bash src/generate_thumbnails.sh "branches/$id" "$THUMB_WIDTH"
            fi
          done <<< "$SERVERS"

      - name: Check for new images
        id: check_new
        run: |
          new_count=0
          SERVERS=$(node -e "const c=require('./config.json'); c.servers.forEach(s => console.log(s.id))")
          while IFS= read -r id; do
            txt="Wallpapers/images_url/${id}.txt"
            if [ -f "$txt" ] && [ -s "$txt" ]; then
              count=$(wc -l < "$txt")
              new_count=$((new_count + count))
            fi
          done <<< "$SERVERS"
          echo "New images found: $new_count"
          if [ "$new_count" -gt 0 ]; then
            echo "has_new=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_new=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set release tag
        id: set_tag
        if: steps.check_new.outputs.has_new == 'true'
        run: |
          TAG="wallpapers-$(date -u +%Y%m%d-%H%M%S)"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Release tag: $TAG"

      - name: Push images to per-server branches
        if: steps.check_new.outputs.has_new == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          SERVERS=$(node -e "const c=require('./config.json'); c.servers.forEach(s => console.log(s.id + ' ' + s.branch))")
          while IFS=' ' read -r id branch; do
            BRANCH_DIR="branches/$id"
            IMAGE_COUNT=$(find "$BRANCH_DIR" -maxdepth 1 -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' \) 2>/dev/null | wc -l)
            if [ ! -d "$BRANCH_DIR" ] || [ "$IMAGE_COUNT" -eq 0 ]; then
              echo "â­ï¸ No images for $id, skipping branch push."
              continue
            fi

            echo "ðŸ”€ Processing branch: $branch (server: $id)"

            # Create a temporary directory for branch work
            WORK_DIR=$(mktemp -d)
            rm -rf "$WORK_DIR"  # git clone needs non-existent target

            # Initialize or clone the branch
            if git ls-remote --exit-code origin "$branch" >/dev/null 2>&1; then
              git clone --single-branch --branch "$branch" --depth 1 "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" "$WORK_DIR"
            else
              mkdir -p "$WORK_DIR"
              cd "$WORK_DIR"
              git init
              git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
              git checkout -b "$branch"
              cd -
            fi

            # Copy images and thumbnails
            find "$BRANCH_DIR" -maxdepth 1 -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' \) -exec cp {} "$WORK_DIR/" \;
            if [ -d "$BRANCH_DIR/thumbnails" ]; then
              mkdir -p "$WORK_DIR/thumbnails"
              find "$BRANCH_DIR/thumbnails" -maxdepth 1 -type f -exec cp {} "$WORK_DIR/thumbnails/" \;
            fi

            # Generate branch README directly in WORK_DIR
            BRANCH_DIR="$WORK_DIR" BRANCH_README_OUTPUT="$WORK_DIR/README.md" node src/generate_readme.js branch "$id"

            # Commit and push
            cd "$WORK_DIR"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            if git diff --cached --quiet; then
              echo "  No changes for $branch."
            else
              git commit -m "Auto-sync: Update $id wallpapers"
              git push origin HEAD:"$branch" --force-with-lease
              echo "  âœ… Pushed to $branch"
            fi
            cd -
            rm -rf "$WORK_DIR"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update main README
        if: steps.check_new.outputs.has_new == 'true'
        run: |
          node src/generate_readme.js main
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --cached --quiet; then
            echo "No README changes."
          else
            git commit -m "Auto-sync: Update main README with branch links"
            git push
          fi

      - name: Collect release assets
        if: steps.check_new.outputs.has_new == 'true'
        id: release_notes
        run: |
          mkdir -p release_assets
          RELEASE_BODY=""
          SERVERS=$(node -e "const c=require('./config.json'); c.servers.forEach(s => console.log(s.id + '|' + s.name + '|' + s.branch))")
          while IFS='|' read -r id name branch; do
            txt="Wallpapers/images_url/${id}.txt"
            if [ -f "$txt" ] && [ -s "$txt" ]; then
              BRANCH_DIR="branches/$id"
              FILE_LIST=""
              FILE_COUNT=0
              while IFS= read -r url; do
                filename=$(basename "$url")
                if [ -f "$BRANCH_DIR/$filename" ]; then
                  FILE_LIST="${FILE_LIST}${filename}\n"
                  FILE_COUNT=$((FILE_COUNT + 1))
                fi
              done < "$txt"

              # Create a zip file for this server with only new images
              if [ $FILE_COUNT -gt 0 ]; then
                ZIP_NAME="${id}-wallpapers.zip"
                while IFS= read -r url; do
                  filename=$(basename "$url")
                  if [ -f "$BRANCH_DIR/$filename" ]; then
                    zip -j "release_assets/$ZIP_NAME" "$BRANCH_DIR/$filename"
                  fi
                done < "$txt"

                # Build release notes section for this server
                RELEASE_BODY="${RELEASE_BODY}### ðŸ–¼ï¸ ${name} (${FILE_COUNT} new)\n\n"
                RELEASE_BODY="${RELEASE_BODY}ðŸ“¦ **Download:** \`${ZIP_NAME}\`\n"
                RELEASE_BODY="${RELEASE_BODY}ðŸ”— **Branch:** [\`${branch}\`](https://github.com/${GITHUB_REPOSITORY}/tree/${branch})\n\n"

                RELEASE_BODY="${RELEASE_BODY}<details><summary>ðŸ“‹ File list & preview</summary>\n\n"
                RELEASE_BODY="${RELEASE_BODY}| Preview | Filename | URL |\n"
                RELEASE_BODY="${RELEASE_BODY}|---------|----------|-----|\n"
                while IFS= read -r url; do
                  filename=$(basename "$url")
                  thumb_url="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${branch}/thumbnails/$(echo "$filename" | sed 's/ /%20/g')"
                  RELEASE_BODY="${RELEASE_BODY}| <img src=\"${thumb_url}\" width=\"100\"> | \`${filename}\` | [Link](${url}) |\n"
                done < "$txt"
                RELEASE_BODY="${RELEASE_BODY}\n</details>\n\n---\n\n"
              fi
            fi
          done <<< "$SERVERS"

          # Write release body to file
          echo -e "$RELEASE_BODY" > release_notes.md

      - name: Create GitHub Release
        if: steps.check_new.outputs.has_new == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.set_tag.outputs.tag }}
          name: "Wallpapers ${{ steps.set_tag.outputs.tag }}"
          body_path: release_notes.md
          files: release_assets/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
